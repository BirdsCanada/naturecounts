---
title: "05-LandcoverData"
author: "Dimitrios Markou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 5: Landcover Data

##### Author: Dimitrios Markou

The NatureCounts_SpatialData_Tutorial modules aim to help users integrate NatureCounts data with spatial and environmental layers in R and meet their conservation and research goals. In [Chapter 4](04-EnvironmentalData.Rmd), you processed Digital Terrain Models, applied crop, mask, and reclassification procedures, and extracted elevation values to link with NatureCounts data.

Spatial data mapping can help you explore possible associations between species occurrences, climate, and other environmental variables of interest. Integrating diverse NatureCounts datasets can, therefore, help inform species distribution models, select predictor variables, and provide clear way to communicate your data.

In this tutorial, you will extract unique pixel values from landcover data to link with NatureCounts data. **Land cover** describes the surface cover on the ground like vegetation, urban, water, and bare soil while **land use** describes the purpose that the land serves like recreation, wildlife habitat, and agriculture. See [Land Cover & Land Use](https://natural-resources.canada.ca/maps-tools-and-publications/satellite-imagery-elevation-data-and-air-photos/tutorial-fundamentals-remote-sensing/educational-resources-applications/land-cover-land-use/land-cover-land-use/9373) from Natural Resources Canada for more information.

**After downloading the necessary packages in [5.0 Learning Objectives] be sure to follow the [Preliminary Steps] section found at the end of this document before proceeding with the tutorial. It helps you preprocess the National Park boundary and NatureCounts data which are required for this lesson.**

# 5.0 Learning Objectives

By the end of **Chapter 5 - LandcoverData**, users will know how to:

-   Process landcover data
-   Extract unique pixel values
-   Link NatureCounts data to landcover data for analysis

This R tutorial requires the following packages:

```{r, eval = TRUE, warning = FALSE, message = FALSE}
library(naturecounts)
library(sf)
library(terra)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
```

This tutorial uses the following spatial data.

1.  [Places administered by Parks Canada](https://open.canada.ca/data/en/dataset/e1f0c975-f40c-4313-9be2-beb951e35f4e/resource/0744186a-449b-4f1f-9f1e-952a94c6d5ca) - Boundary shapefiles

2.  [2015 Land Cover of Canada](https://open.canada.ca/data/en/dataset/4e615eae-b90c-420b-adee-2ca35896caf6) - Landcover map (30 m resolution)

# 5.1 Landcover Data

Read the landcover dataset using `terra::rast()`.

```{r}
#if the data are in your working directory
landcover <- rast("landcover-2015-classification.tif")

#else, specify the location of your data
landcover<-rast("path/to/your/landcover-2015-classification.tif")
```

Transform the crs of the National Park boundary to match that of the landcover dataset.

```{r}
mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(landcover))
```

Crop the national dataset to reduce the extent of the raster to the extent of the National Park.

```{r}
landcover_crop <- crop(landcover, vect(mauricie_boundary))
```

Mask the national dataset to apply NA values to all cells outsides of the extent of the National Park.

```{r}
landcover_mask <- mask(landcover, vect(mauricie_boundary))
```

To assign the land cover class label and pixel count to each pixel value we can use the `unique()` function, assign landcover class labels (see [Class Index](https://open.canada.ca/data/en/dataset/ee1580ab-a23d-4f86-a09b-79763677eb47/resource/b8411562-49b7-4cf6-ac61-dbb893b182cc)), and apply the `freq()` function.

```{r}
# Extract the unique pixel values from the cropped landcover raster
unique_vales <- unique(landcover_crop)

# Assign land cover class labels according to the pixel values (in the correct order)
unique_vales$landcover <- c("needleleaf", "broadleaf", "mixed forest", "shrubland", "grassland", "wetland", "cropland", "barren", "urban", "water")

# Add pixel count for each class
pixel_freq <- freq(landcover_crop)
unique_vales$pixelcount <- pixel_freq$count

unique_vales
```

Plot the landcover raster and National Park boundary.

```{r, eval = TRUE, warning = FALSE}
# Match the CRS
mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(landcover_crop))

# Plot landcover
plot(landcover_crop, axes = TRUE, plg = list(title = "Landcover"), main = "La Mauricie National Park - Landcover 2015")

# Overlay the Mauricie boundary on the first plot
plot(mauricie_boundary, add = TRUE, border = "red", col = NA, lwd = 2)
```

Summarize the NatureCounts data for mapping and covert it to SpatVector format.

```{r}
# Group by SiteCode and summarize total_count
mauricie_site_summary <- mauricie_birds %>%
  group_by(SiteCode) %>%
  summarize(total_count = sum(ObservationCount, na.rm = TRUE))
```

```{r}
mauricie_birds_vect <- vect(mauricie_birds) # Converts to SpatVector format
```

To map the NatureCounts and landcover data:

```{r}
mauricie_site_summary <- st_transform(mauricie_site_summary, crs = st_crs(landcover_crop)) # Match the CRS

# Plot landcover raster for La Mauricie National Park
plot(landcover_crop, main = "Landcover across La Mauricie National Park")

# Overlay the National Park boundary in red
plot(st_geometry(mauricie_boundary), col = NA, border = "red", add = TRUE)

# Overlay the multipoints from the site summary in blue
plot(st_geometry(mauricie_site_summary), 
     add = TRUE, 
     pch = 19,      # Solid circle
     col = "yellow",  # Point color
     cex = 0.5)     # Point size
```

Extract pixel values for each bird observation site and append it to `mauricie_birds`.

```{r}
mauricie_birds <- st_transform(mauricie_birds, crs(mauricie_sl_ndvi)) # Match the CRS

pixel_values <- terra::extract(landcover_crop, mauricie_birds_vect) # Extracts the NDVI values for each point

pixel_values <- cbind(record_id = mauricie_birds$record_id, pixel_ID = pixel_values[, 2]) # Creates the record_id and pixel_ID columns 
```

# Preliminary Steps

[La Mauricie National Park](https://parks.canada.ca/pn-np/qc/mauricie/nature) is situated in the Laurentian mountains and covers 536 km2 within the Eastern Canadian Temperate-Boreal Forest transition ecoregion. The environment is characterized by mixed forests, lakes, rivers, and hills that range from from 150 m to over 500 m in elevation. The park provides suitable habitat for a variety of wildlife including at least 215 bird species.

Read the National Park polygons into R.

```{r eval = FALSE}
#if in your working directory
national_parks<-st_read("vw_Places_Public_lieux_public_APCA.shp")

#else, specify your directory
national_parks <- st_read("path/to/your/shp")

```

Filter the national_parks dataset for La Mauricie National Park.

```{r}
View(national_parks) #to find the correct object ID

mauricie_boundary <- national_parks %>%
  filter(OBJECTID == "21")

# Drop the Z-dimension (3D component) to make it 2D
mauricie_boundary <- st_zm(mauricie_boundary, drop = TRUE, what = "ZM")
```

Write the boundary as a shapefile to your disk.

```{r, eval=FALSE, message=FALSE}

st_write(mauricie_boundary, "mauricie_boundary.shp")

# you will want the KML file for section 3.8
st_write(mauricie_boundary, "mauricie_boundary.kml", driver="KML")
```

To assess the species distribution within the National Park, we will use data from the [Quebec Breeding Bird Atlas (2010 - 2014)](https://naturecounts.ca/nc/default/datasets.jsp?code=QCATLAS2PC&sec=bmdr) which is part of a 5 year project that covers the distribution and abundance of all species breeding in the province.

Don't forget to replace `testuser` with your NatureCounts username. You will be prompted for your password.

Read in the list of species represented in NatureCounts:

```{r}
species_names <- search_species()
```

Download NatureCounts data:

```{r}
quebec_atlas <- nc_data_dl(collections = "QCATLAS2PC", username = "testuser", info = "spatial_data_tutorial", timeout = 500)
```

eBird has the greatest number of provincial bird records, however, this collection comprise data of Access Level 4. If you wish to access this collection you must sign up for a free account and [make a data request](https://naturecounts.ca/nc/default/explore.jsp#download). Otherwise, you can carry forward with the tutorial without these data and skip this code chunk.

```{r, eval = FALSE}
quebec_atlas <- nc_data_dl(collections = c("QCATLAS2PC", "EBIRD-CA-QC"), username = "testuser", info = "spatial_data_tutorial")
```

To create date and doy columns and ensure that the ObservationCount column is in the correct numeric format we can apply the `format_dates()` and `mutate()` functions. We will also filter the dataset to exclude rows with missing coordinates.

```{r}
quebec_atlas <- quebec_atlas %>%
  format_dates() %>%  # create the date and doy columns 
  mutate(ObservationCount = as.numeric(ObservationCount)) %>%  # convert to numeric format
  filter(!is.na(longitude) & !is.na(latitude))  # remove rows with missing coordinates
```

To convert the NatureCounts data to a spatial object and transform its crs to match the National Park boundary we can use the `st_as_sf()` and `st_transform()` functions, respectively.

```{r}
quebec_atlas_sf <- sf::st_as_sf(quebec_atlas,
                        coords = c("longitude", "latitude"), crs = 4326) # converts the quebec_atlas data to an sf object

mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(quebec_atlas_sf)) # match the CRS
```

Clip the NatureCounts data to the National Park boundary using `st_intersection()`.

```{r, warning=FALSE}
mauricie_birds <- sf::st_intersection(quebec_atlas_sf, mauricie_boundary)
```

Append the species names to the clipped NatureCounts dataset based on `species_id` code.

```{r}
mauricie_birds <- mauricie_birds %>%
  left_join(species_names, by = "species_id")
```

Tidyverse functions can help us summarize our data in a variety of ways. For example, if we wanted to determine the annual bird count for each year across all sites, we could use `mutate()` and `lubridate()` to extract the survey **year** from the **date** column. The `group_by()` function can then be used to group the observations by year, and `summarise()` can help calculate and create the **annual_count** column. Here, we ensure that the **ObservationCount** is in the correct format by applying `as.numeric()`.

```{r}
mauricie_birds_summary <- mauricie_birds %>%
  mutate(year = lubridate::year(date)) %>% # extracts the survey year using lubridate
  group_by(year) %>%
  summarise(annual_count = sum(as.numeric(ObservationCount), na.rm = TRUE)) %>% # calculates the annual_count
  filter(!is.na(year))  # remove rows with missing year

mauricie_birds_summary
```

If you wanted to summarize total count for each species at each site (i.e., atlas block within the park boundary), respectively, you could adjust the pipe like so using `pivot_wider()`.

```{r}
mauricie_species_summary <- mauricie_birds %>%
  st_drop_geometry() %>%  # drop the geometry column
  group_by(species_id, Locality) %>%
  summarise(total_count = sum(as.numeric(ObservationCount), na.rm = TRUE)) %>% # calculates the total_count column
  pivot_wider(names_from = species_id, # populates the column names with each species_id code
              values_from = total_count, # populates each cell with total_count
              values_fill = list(total_count = 0)) %>% # missing values are zero-filled
  group_by(Locality)

mauricie_species_summary
```
