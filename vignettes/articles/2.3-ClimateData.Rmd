---
title: "Chapter 3 - ClimateData"
date: "2024-11-14"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Module 2 - Conservation Areas}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



# Module 3: Climate Data

##### Author: Dimitrios Markou

The NatureCounts_SpatialData_Tutorial modules aim to help users integrate NatureCounts data with spatial and environmental layers in R and meet their conservation and research goals. In [Module 2](02-ConservationAreas.Rmd), you applied geoprocessing functions to spatial (vector) objects and visualized NatureCounts data within KBAs and Priority Places.

Spatial data mapping can help you explore possible associations between species occurrences, climate, and other environmental variables of interest. Integrating diverse NatureCounts datasets can, therefore, help inform species distribution models, select predictor variables, and provide us clear way to communicate your data.

In this tutorial, you will use NatureCounts and climate data to explore possible patterns in Whooping Crane observations, annual mean temperature, and annual mean precipitation within the Wood Buffalo National Park, the province of Alberta, and beyond.

# 3.0 Learning Objectives

By the end of **Module 3 - Climate Data**, users will know how to:

-   Download and preprocess vector and raster climate data in R
-   Combine NatureCounts observations with climate data
-   Visualize NatureCounts and climate data using plots and spatio-temporal maps

This tutorial utilizes the following bird occurrence, spatial, and climate data sources:

| Data | Description |
|------------------------------------|------------------------------------|
| [eBird Canada (Prairies)](https://naturecounts.ca/nc/default/datasets.jsp?code=EBIRD-CA-PR) | NatureCounts, EBIRD-CA-PR (1800-2024) |
| Alberta Breeding Bird Atlas | NatureCounts, ABATLAS1 ([1987-1992](https://naturecounts.ca/nc/default/datasets.jsp?code=ABATLAS1)) and ABATLAS2 ([2000-2005](https://naturecounts.ca/nc/default/datasets.jsp?code=ABATLAS2)) |
| [Alberta Bird Records](https://naturecounts.ca/nc/default/datasets.jsp?code=ABBIRDRECS) | NatureCounts, ABIRDRECS (1941-2006) |
| [Whooping Crane Nesting Area and Summer Range](https://kbacanada.org/site/?SiteCode=NT002) | Key Biodiversity Area boundary (**.shp**) and site attributes |
| [Environment and Climate Change Canada](https://climate.weather.gc.ca/historical_data/search_historic_data_e.html) | Historical (vector) weather data, accessed through the `weathercan` R package |
| [WorldClim](https://www.worldclim.org/data/bioclim.html) | Historical (raster) climate data. Includes nineteen bioclimatic variables representing the 1970-2000 average |

This R tutorial requires the following **packages**:


``` r
library(dplyr)
library(ggplot2)
library(sf)
library(mapview)
library(naturecounts)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(ggspatial)
library(RColorBrewer)
library(raster)
library(tmap)
library(terra)
library(lubridate)

#since weathercan is not available in the recent version of R, we install the package a little differently
#install.packages("weathercan", 
                 #repos = c("https://ropensci.r-universe.dev", 
                           #"https://cloud.r-project.org"))
library(weathercan)
```

# 3.1 Summary Tools

Reminder that, to download data, you need to [sign up](https://naturecounts.ca/nc/default/register.jsp) for a **free** account.

> The data download will not work unless you replace `"testuser"` with your actual user name. You will be prompted to enter your password.


``` r
collections <- meta_collections() 
View(meta_collections())
```


``` r
search_species("whooping crane")
View(search_species("whooping crane"))
```

To download the NatureCounts data, you can specify the collection and species code relevant to your research. Replace `testuser` with your user name.


``` r
whooping_crane_data <- nc_data_dl(collections = c("ABATLAS1", "ABATLAS2", "ABBIRDRECS"), species = 4030, username = "testuser", info = "spatial_data_tutorial")
```

```
## Using filters: collections (ABATLAS1, ABATLAS2, ABBIRDRECS); species (4030); fields_set (BMDE2.00-min)
```

```
## Collecting available records...
```

```
##   collection nrecords
## 1   ABATLAS1       15
## 2   ABATLAS2       67
## 3 ABBIRDRECS        9
## Total records: 91
```

```
## 
## Downloading records for each collection:
```

```
##   ABATLAS1
```

```
##     Records 1 to 15 / 15
```

```
##   ABATLAS2
```

```
##     Records 1 to 67 / 67
```

```
##   ABBIRDRECS
```

```
##     Records 1 to 9 / 9
```

eBird has the greatest number of Whooping Crane records, however, this collection comprise data of Access Level 4. If you wish to access this collection you must sign up for a free account and make a [data request](https://naturecounts.ca/nc/default/explore.jsp#table). Otherwise, you can carry forward with the tutorial without these data and skip this code chunk.


``` r
whooping_crane_data <- nc_data_dl(collections = c("ABATLAS1", "ABATLAS2", "ABBIRDRECS","EBIRD-CA-PR"), species = 4030, username = "testuser", info = "spatial_data_tutorial")
```

Grouping the NatureCounts data might provide more meaningful insight on species occurrences at each site and how they might vary across time and space. To create date and doy columns and ensure that the ObservationCount column is in the correct **numeric** format we can apply the `format_dates` and `mutate` functions :


``` r
whooping_crane_data <- whooping_crane_data %>%
  format_dates() %>% # create the date and doy columns 
  mutate(ObservationCount = as.numeric(ObservationCount)) # convert to numeric
```

You can then summarise species occurrence by SiteCode and date while keeping the coordinate information for each site using the `group_by` and `summarise` functions:


``` r
species_occurrence_summary <- whooping_crane_data %>%
  group_by(SiteCode, date, longitude, latitude) %>%
  summarise(total_count = sum(as.numeric(ObservationCount), na.rm = TRUE)) %>%
  ungroup()
```

```
## `summarise()` has grouped output by 'SiteCode', 'date', 'longitude'. You can override using the `.groups` argument.
```

Lastly, you can summarize the NatureCounts data once more to get the annual total counts of Whooping Cranes, say between 1985 and 2011. To do so, we can 1) produce a regular dataframe called **cranes_summary** by dropping the geometry column (`st_drop_geometry`) 2) create the **date** column using `lubridate` and group by year 3) calculate the **annual_count** by using the `summarise` and `sum` functions and 4) filter for NA values and by **year:**


``` r
cranes_summary <- species_occurrence_summary %>%
  st_drop_geometry() %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(annual_count = sum(total_count, na.rm = TRUE)) %>%
  filter(!is.na(year)) %>%
  filter(year >= 1985 & year <= 2011)
cranes_summary
```

```
## # A tibble: 11 × 2
##     year annual_count
##    <dbl>        <dbl>
##  1  1987            0
##  2  1988            0
##  3  1990            0
##  4  1991            0
##  5  1996            1
##  6  2000           24
##  7  2001           14
##  8  2002           26
##  9  2003           14
## 10  2004           18
## 11  2005          180
```

# 3.2 Weathercan (Vector) Data

`weathercan` is an R package designed to help access historical weather data from ECCC. Steffi LaZerte's online tutorial, [Integrating data from weathercan](https://ropensci.org/blog/2018/03/06/weathercan/), provides more details on how to download, filter, and visualize weather data in R.

First, let's take a look at the built in **stations** dataset:


``` r
stations <- weathercan::stations()
```

```
## The stations data frame hasn't been updated in over 4 weeks. Consider running `stations_dl()` to check for updates and make sure you have the most recent stations list available
```

``` r
head(stations)
```

```
## # A tibble: 6 × 16
##   prov  station_name        station_id climate_id WMO_id TC_id   lat   lon  elev tz       interval start   end normals normals_1981_2010
##   <chr> <chr>                    <dbl> <chr>       <dbl> <chr> <dbl> <dbl> <dbl> <chr>    <chr>    <dbl> <dbl> <lgl>   <lgl>            
## 1 AB    DAYSLAND                  1795 301AR54        NA <NA>   52.9 -112.  689. Etc/GMT… day       1908  1922 FALSE   FALSE            
## 2 AB    DAYSLAND                  1795 301AR54        NA <NA>   52.9 -112.  689. Etc/GMT… hour        NA    NA FALSE   FALSE            
## 3 AB    DAYSLAND                  1795 301AR54        NA <NA>   52.9 -112.  689. Etc/GMT… month     1908  1922 FALSE   FALSE            
## 4 AB    EDMONTON CORONATION       1796 301BK03        NA <NA>   53.6 -114.  671. Etc/GMT… day       1978  1979 FALSE   FALSE            
## 5 AB    EDMONTON CORONATION       1796 301BK03        NA <NA>   53.6 -114.  671. Etc/GMT… hour        NA    NA FALSE   FALSE            
## 6 AB    EDMONTON CORONATION       1796 301BK03        NA <NA>   53.6 -114.  671. Etc/GMT… month     1978  1979 FALSE   FALSE            
## # ℹ 1 more variable: normals_1971_2000 <lgl>
```

Weather data can also be filtered based on province, interval, station operation period, and elevation to exclude extreme measurements in the weather data download:


``` r
prov_stations <- stations %>%
  filter(prov %in% c("AB"),
         interval == "day",
         start >= 1960,
         end <= 2023,
         elev < 1000)
```

You are ready to download weather data! For the purpose of this tutorial, let's perform a smaller weather data download by specifying specific station IDs. The weather stations closest to Wood Buffalo National Park are BIRCH MOUNTAIN LO (station_id = 2481) and BUCKTON LO (station_id = 2486). These stations were identified using the the ECCC [search option](https://climate.weather.gc.ca/historical_data/search_historic_data_stations_e.html?searchType=stnProx&timeframe=1&txtRadius=25&selCity=&optProxType=park&selPark=57%7C39%7C112%7C0%7CWood+Buffalo+National+Park&txtCentralLatDeg=&txtCentralLatMin=&txtCentralLatSec=&txtCentralLongDeg=&txtCentralLongMin=&txtCentralLongSec=&txtLatDecDeg=&txtLongDecDeg=&optLimit=yearRange&StartYear=1840&EndYear=2024&Year=2024&Month=10&Day=1&selRowPerPage=25) which helps you search for historical weather data based on proximity to a city, coordinate, or National Park.


``` r
birch_station <- stations_search(name = "BIRCH MOUNTAIN LO", interval = "day")
buckton_station <- stations_search(name = "BUCKTON LO", interval = "day")
wood_buff_stations <- rbind(birch_station, buckton_station) # combine 
```

Now you can perform the weather data download (give it a few minutes).


``` r
weather <- weather_dl(station_ids = wood_buff_stations$station_id,
                         start = "1985-01-01",
                         end = "2011-12-31",
                         interval = "day", quiet = TRUE)
```

NOTE - Larger data downloads can be performed based on filtered stations data-sets as well as start, end, and interval specifications. Large historical weather downloads can take a while!


``` r
# weather <- weather_dl(station_ids = prov_stations$station_id,
                         # start = "2000-01-01",
                         # end = "2023-12-31",
                         # interval = "day", quiet = TRUE)
```

Next, convert the date column to Date data type. This will allow you to apply more filters based on month and survey year:


``` r
weather$date <- as.Date(weather$date)
```

Finally, to summarize the weather data by calculating the annual mean summer temperature and precipitation we can use the familiar `filter`, `group_by`, and `summarise` functions:


``` r
yearly_climate <- weather %>%
  filter(lubridate::month(date) %in% 5:8) %>%  # Filter for summer months May (5) through August (8)
  group_by(year = lubridate::year(date)) %>%   # Group by year
  summarize(
    yearly_avg_temp = mean(mean_temp, na.rm = TRUE),
    yearly_avg_precip = mean(total_precip, na.rm = TRUE)
  )
yearly_climate
```

```
## # A tibble: 27 × 3
##     year yearly_avg_temp yearly_avg_precip
##    <dbl>           <dbl>             <dbl>
##  1  1985            11.6              1.14
##  2  1986            11.7              2.96
##  3  1987            11.8              2.71
##  4  1988            12.1              3.40
##  5  1989            13.0              1.85
##  6  1990            13.1              2.44
##  7  1991            13.4              3.40
##  8  1992            11.2              2.40
##  9  1993            10.7              3.00
## 10  1994            13.2              3.39
## # ℹ 17 more rows
```

Now that you have prepared the NatureCounts and weathercan climate data you can combine the data together for analysis.


``` r
cranes_climate_summary <- left_join(cranes_summary, yearly_climate, by="year")
cranes_climate_summary
```

```
## # A tibble: 11 × 4
##     year annual_count yearly_avg_temp yearly_avg_precip
##    <dbl>        <dbl>           <dbl>             <dbl>
##  1  1987            0            11.8              2.71
##  2  1988            0            12.1              3.40
##  3  1990            0            13.1              2.44
##  4  1991            0            13.4              3.40
##  5  1996            1            11.7              3.37
##  6  2000           24            10.6              3.83
##  7  2001           14            13.7              2.76
##  8  2002           26            11.3              3.18
##  9  2003           14            12.9              2.72
## 10  2004           18            10.6              2.08
## 11  2005          180            10.7              2.89
```

To visualize average annual summer temperature and total count, you can use a scatterplot.


``` r
ggplot(cranes_climate_summary, aes(x = yearly_avg_temp, y = annual_count)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +  # Simple blue points
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # Add linear regression line
  theme_minimal() +
  labs(x = "Avg Temperature (°C)", 
       y = "Total Count", 
       title = "Whooping Crane Count vs. Annual Avg Summer Temp") +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title
```

```
## `geom_smooth()` using formula = 'y ~ x'
```

![plot of chunk average_temp](figure/average_temp-1.png)
![plot of chunk average_temp](figures/spatdatatutorial_average_temp-1.png)

Or do the same for annual summer precipitation:


``` r
ggplot(cranes_climate_summary, aes(x = yearly_avg_precip, y = annual_count)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +  # Simple blue points
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # Add linear regression line
  theme_minimal() +
  labs(x = "Avg Precipitation", 
       y = "Total Count", 
       title = "Whooping Crane Count vs. Annual Avg Summer Precip") +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title
```

```
## `geom_smooth()` using formula = 'y ~ x'
```

![plot of chunk unnamed-chunk-16](figure/unnamed-chunk-16-1.png)
![plot of chunk average_precip](figures/spatdatatutorial_average_precip-1.png)


# 3.3 WorldClim (Raster) Data

[WorldClim](https://www.worldclim.org/data/index.html) provides high spatial resolution global weather and climate data. Their data is in raster GeoTiff (.tif) file format and comprises a variety of variables including 19 [bioclimatic](https://www.worldclim.org/data/bioclim.html) variables representing annual trends, seasonality, and extreme environmental factors. In this next section you will manipulate climate data rasters and associate them with NatureCounts data.

Download the bioclimatic data on [this webpage](https://www.worldclim.org/data/worldclim21.html). The data are available at the four spatial resolutions, between 30 seconds (\~1 km2) to 10 minutes (\~340 km2). Each download is a "zip" file containing 19 GeoTiff (.tif) files, one for each month of the variables. For this tutorial, we recommend you download the 10 minute resolution.

After dowloading the WorldClim data to your working directory, list all the files in the raster stack by specifying the path to your folder (use `list.files` function) and read them into R using the `rast` function.

This code will get the path to your working directory.


``` r
getwd()
```

Now point the `list.file` to this directory using the sample code below.


```
## class       : SpatRaster 
## dimensions  : 1080, 2160, 19  (nrow, ncol, nlyr)
## resolution  : 0.1666667, 0.1666667  (x, y)
## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## coord. ref. : lon/lat WGS 84 (EPSG:4326) 
## sources     : wc2.1_10m_bio_1.tif  
##               wc2.1_10m_bio_10.tif  
##               wc2.1_10m_bio_11.tif  
##               ... and 16 more source(s)
## names       : wc2.1~bio_1, wc2.1~io_10, wc2.1~io_11, wc2.1~io_12, wc2.1~io_13, wc2.1~io_14, ... 
## min values  :   -54.72435,   -37.78142,   -66.31125,           0,           0,           0, ... 
## max values  :    30.98764,    38.21617,    29.15299,       11191,        2381,         484, ...
```


``` r
worldclim_list <- list.files(path = "C:/YOUR/PATH/HERE", pattern = "\\.tif$", full.names = TRUE)

# Read and stack the raster files
worldclim_stack <- rast(worldclim_list)

# Print information about the stack
print(worldclim_stack)
```

Great! The raster stack which includes the 19 bio-climatic variables has been read into R successfully. We can simplify the layer names which represent each variable, respectively:


``` r
names(worldclim_stack) <- paste0("bio", 1:19)
```

Let's take a look at the first layer 'bio1' which is Annual Mean Temperature. To do so, you can subset the layers of the SpatRaster with \$ or two sets of square brackets [ [ ] ].


``` r
# Plot the first bio-climatic layer (e.g., bio1: Annual Mean Temperature)
plot(worldclim_stack[["bio1"]], main = "Annual Mean Temperature (bio1)")

![plot of chunk bio1](figures/spatdatatutorial_bio1-1.png)

# Summary statistics for each layer
summary(worldclim_stack)
```

```
## Error: <text>:4:2: unexpected '['
## 3: 
## 4: ![
##     ^
```

Convert the **species_occurences_summary**, which summarises species occurrence by SiteCode, into a spatial object using the `st_as_sf` function:


``` r
cranes_sf <- sf::st_as_sf(species_occurrence_summary,
                        coords = c("longitude", "latitude"), crs = 4326)
```

Extract the bio-climatic variable values for each bird observation site, respectively.


``` r
bioclim_values <- extract(worldclim_stack, cranes_sf)
```

Then combine the bio-climatic values with the NatureCounts data.


``` r
bioclim_data <- cbind(cranes_sf, bioclim_values, longitude = species_occurrence_summary$longitude, latitude =  species_occurrence_summary$latitude)
```

Filter the data to only include observations made post 1970 to match the temporal resolution of the climate dataset:


``` r
bioclim_data <- bioclim_data %>%
  mutate(date = as.Date(date)) %>%
  filter(year(date) >= "1970")
summary(bioclim_data)
```

```
##    SiteCode              date             total_count            ID             bio1             bio2            bio3        
##  Length:82          Min.   :1987-06-01   Min.   :  0.000   Min.   : 1.00   Min.   :-2.727   Min.   :14.11   Min.   :-21.910  
##  Class :character   1st Qu.:2001-06-01   1st Qu.:  1.000   1st Qu.:23.25   1st Qu.:-2.402   1st Qu.:14.73   1st Qu.:-21.183  
##  Mode  :character   Median :2002-08-14   Median :  1.000   Median :43.50   Median :-2.356   Median :14.80   Median :-20.890  
##                     Mean   :2002-01-29   Mean   :  3.378   Mean   :44.05   Mean   :-1.095   Mean   :14.92   Mean   :-18.647  
##                     3rd Qu.:2004-06-22   3rd Qu.:  2.000   3rd Qu.:63.75   3rd Qu.: 0.914   3rd Qu.:15.06   3rd Qu.:-15.367  
##                     Max.   :2005-08-01   Max.   :160.000   Max.   :90.00   Max.   : 4.088   Max.   :15.83   Max.   : -7.527  
##       bio4            bio5             bio6            bio7            bio8            bio9           bio10           bio11      
##  Min.   :346.0   Min.   : 52.00   Min.   :10.00   Min.   :42.27   Min.   :135.0   Min.   :34.00   Min.   :134.0   Min.   :34.00  
##  1st Qu.:351.0   1st Qu.: 56.00   1st Qu.:14.00   1st Qu.:45.72   1st Qu.:144.0   1st Qu.:44.00   1st Qu.:144.0   1st Qu.:53.00  
##  Median :352.0   Median : 56.00   Median :14.00   Median :46.59   Median :147.0   Median :44.00   Median :147.0   Median :53.00  
##  Mean   :379.0   Mean   : 64.62   Mean   :13.82   Mean   :52.49   Mean   :168.9   Mean   :45.68   Mean   :168.8   Mean   :52.12  
##  3rd Qu.:404.8   3rd Qu.: 75.00   3rd Qu.:14.00   3rd Qu.:65.52   3rd Qu.:205.8   3rd Qu.:46.75   3rd Qu.:205.8   3rd Qu.:53.00  
##  Max.   :543.0   Max.   :104.00   Max.   :17.00   Max.   :74.12   Max.   :270.0   Max.   :56.00   Max.   :270.0   Max.   :58.00  
##      bio12           bio13           bio14            bio15           bio16            bio17           bio18           bio19       
##  Min.   :11.16   Min.   :21.53   Min.   : 940.5   Min.   :21.38   Min.   :-29.17   Min.   :39.16   Min.   :12.90   Min.   :-13.17  
##  1st Qu.:11.90   1st Qu.:23.42   1st Qu.:1256.0   1st Qu.:22.80   1st Qu.:-28.41   1st Qu.:45.44   1st Qu.:14.73   1st Qu.:-11.01  
##  Median :12.06   Median :23.68   Median :1449.9   Median :22.96   Median :-28.03   Median :51.00   Median :14.80   Median :-10.89  
##  Mean   :12.01   Mean   :24.84   Mean   :1368.1   Mean   :22.86   Mean   :-25.84   Mean   :48.69   Mean   :14.90   Mean   :-10.84  
##  3rd Qu.:12.07   3rd Qu.:25.74   3rd Qu.:1465.4   3rd Qu.:23.06   3rd Qu.:-22.64   3rd Qu.:51.47   3rd Qu.:15.06   3rd Qu.:-10.72  
##  Max.   :13.45   Max.   :33.67   Max.   :1499.5   Max.   :23.69   Max.   :-15.46   Max.   :51.83   Max.   :15.83   Max.   : -3.01  
##    longitude         latitude              geometry 
##  Min.   :-117.1   Min.   :51.05   POINT        :82  
##  1st Qu.:-113.3   1st Qu.:55.00   epsg:4326    : 0  
##  Median :-113.0   Median :59.96   +proj=long...: 0  
##  Mean   :-112.9   Mean   :58.09                     
##  3rd Qu.:-113.0   3rd Qu.:59.98                     
##  Max.   :-110.3   Max.   :60.21
```

Combine the bioclimatic values with the NatureCounts data.


``` r
bioclim_data <- cbind(cranes_sf, bioclim_values, longitude = species_occurrence_summary$longitude, latitude = species_occurrence_summary$latitude)
bioclim_data
```

```
## Simple feature collection with 90 features and 25 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -117.0861 ymin: 51.05 xmax: -110.1519 ymax: 60.21
## Geodetic CRS:  WGS 84
## First 10 features:
##    SiteCode       date total_count ID       bio1     bio2      bio3 bio4 bio5 bio6     bio7 bio8 bio9 bio10 bio11    bio12    bio13
## 1     11797 2002-08-20           2  1  1.9566667 15.47583 -13.30629  404   75   11 65.96692  205   47   205    47 11.81379 27.58234
## 2     11797 2002-08-25           2  2  1.9566667 15.47583 -13.30629  404   75   11 65.96692  205   47   205    47 11.81379 27.58234
## 3      3101 1991-07-30           0  3  2.3572292 14.11429 -10.74292  543  104   16 69.63081  270   52   270    52 13.45487 33.29797
## 4      3772       <NA>           0  4 -0.1956979 15.62317 -18.14871  384   66   17 49.89345  169   54   169    59 13.88502 27.26362
## 5      4070       <NA>           0  5 -2.4016979 14.80050 -21.18279  352   56   14 46.58709  147   44   147    53 12.05515 23.42260
## 6      4493 1988-04-06           0  6  2.9629478 15.55025 -10.82917  473   96   14 71.19943  248   51   248    51 11.99869 29.36878
## 7      4496 1990-06-12           0  7  2.6983852 15.20204 -11.07858  481   97   15 66.41271  241   56   241    56 11.46485 28.64012
## 8      4496 1990-06-23           0  8  2.6983852 15.20204 -11.07858  481   97   15 66.41271  241   56   241    56 11.46485 28.64012
## 9     46490 2001-06-08           1  9  1.8674064 15.28687 -13.16629  429   90   12 72.78478  226   46   226    46 12.53444 29.47910
## 10    46809 2005-06-21           2 10  2.4437709 14.55458 -10.91737  485   97   16 71.39149  251   53   251    53 11.99404 29.99973
##       bio14    bio15     bio16    bio17    bio18      bio19 longitude latitude                   geometry
## 1  1175.087 22.68150 -20.14950 42.83100 15.47583 -10.987542 -111.2333 53.31667 POINT (-111.2333 53.31667)
## 2  1175.087 22.68150 -20.14950 42.83100 15.47583 -10.987542 -111.2333 53.31667 POINT (-111.2333 53.31667)
## 3  1013.335 21.62550 -18.78200 40.40750 14.11429 -10.742916 -114.7319 52.19556 POINT (-114.7319 52.19556)
## 4  1376.248 24.49950 -26.42925 50.92875 15.62317  -7.211417 -114.0139 58.29278 POINT (-114.0139 58.29278)
## 5  1465.385 23.05700 -28.41100 51.46800 14.80050 -10.889375 -112.8739 59.84111 POINT (-112.8739 59.84111)
## 6  1077.446 22.97100 -17.88425 40.85525 15.55025 -10.829167 -113.1350 52.46778  POINT (-113.135 52.46778)
## 7  1076.315 21.91350 -18.11725 40.03075 15.20204 -11.078583 -113.1478 52.73722 POINT (-113.1478 52.73722)
## 8  1076.315 21.91350 -18.11725 40.03075 15.20204 -11.078583 -113.1478 52.73722 POINT (-113.1478 52.73722)
## 9  1170.808 22.48075 -20.03900 42.51975 15.28687 -13.166291 -112.2684 53.84702 POINT (-112.2684 53.84702)
## 10 1038.404 21.54975 -18.43075 39.98050 14.55458  -3.009958 -113.8755 52.54012 POINT (-113.8755 52.54012)
```

Visualize the distribution of **bio1** compared to **total_count**:


``` r
# Scatter plot of bird observations against a bioclimatic variable (bio1)
ggplot(data = bioclim_data, aes(x = bio15, y = total_count)) +
  geom_point(alpha = 0.6) +
  labs(title = "Bird Observations vs. Bioclimatic Variable (bio1)",
       x = "Bioclimatic Variable",
       y = "ObservationCount") +
  theme_minimal()
```

![plot of chunk scatterplot_bio1](figure/scatterplot_bio1-1.png)

![plot of chunk scatterplot_bio1](figures/spatdatatutorial_scatterplot_bio1-1.png)

Map the NatureCounts data by grouping it by **SiteCode**, sizing the points by **total_count** and colorizing them by a bio-climatic variable (**bio1**):


``` r
bioclim_data <- st_transform(bioclim_data, crs = 4326)
```


``` r
# Group by SiteCode and summarize total_count
bioclim_data <- bioclim_data %>%
  group_by(SiteCode) %>%
  summarize(total_count = sum(total_count, na.rm = TRUE),
            bio1 = mean(bio1, na.rm = TRUE),
            latitude = first(latitude),
            longitude = first(longitude))

# Define color palette for bio1
pal <- colorNumeric(palette = "YlOrRd", domain = bioclim_data$bio1)

# Define a scaling factor for total_count
scaling_factor <- 2  # Adjust this to scale the circle size

# Plot using leaflet
leaflet(bioclim_data) %>%
  addTiles() %>%
  addCircleMarkers(
    ~longitude, ~latitude,
    radius = ~pmin(pmax(sqrt(total_count) * scaling_factor, 3), 15),  # Scale and limit radius
    fillColor = ~pal(bio1),      # Color points by bio1
    color = "black", stroke = TRUE, fillOpacity = 0.8,
    popup = ~paste0("<strong>SiteCode:</strong> ", SiteCode, "<br>", "<strong>Total Count:</strong> ", total_count, "<br>",      "<strong>Bio1:</strong> ", bio1) # creates info popup labels
  ) %>%
  addLegend(pal = pal, values = ~bio1, title = "Bio1", position = "bottomright") %>%
  addScaleBar(position = "bottomleft", options = scaleBarOptions(imperial = FALSE))
```

**Congratulations**! You've completed **Module 3 - Climate Data**. Here, you successfully combined NatureCounts data with vector and raster climate data in R. In [Module 4](04-EnvironmentalData.Rmd) you can explore how-to link NatureCounts observations with other environmental variables like elevation, landcover, and spectral indices.
