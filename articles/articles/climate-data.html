<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adding Climate Data • naturecounts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Adding Climate Data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">naturecounts</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BirdStudiesCanada/naturecounts">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="climate-data_files/htmlwidgets-1.3/htmlwidgets.js"></script><script src="climate-data_files/jquery-1.12.4/jquery.min.js"></script><link href="climate-data_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="climate-data_files/datatables-binding-0.5/datatables.js"></script><link href="climate-data_files/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="climate-data_files/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="climate-data_files/dt-core-1.10.16/js/jquery.dataTables.min.js"></script><link href="climate-data_files/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet">
<script src="climate-data_files/crosstalk-1.0.0/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Adding Climate Data</h1>
            
            <h4 class="date">2019-07-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/BirdStudiesCanada/naturecounts/blob/master/vignettes/articles/climate-data.Rmd"><code>vignettes/articles/climate-data.Rmd</code></a></small>
      <div class="hidden name"><code>climate-data.Rmd</code></div>

    </div>

    
    
<p>Climate data can be important in analyses of population presence/absence as some species may be more or less active depending on rain, temperature, or wind. Climate may also affect the odds of detecting species that are present (e.g., in windy conditions it may be harder to detect small birds in trees or to hear their vocalizations).</p>
<p>In this tutorial we will download climate data from Environment and Climate Change Canada using the <a href="http://ropensci.github.io/weathercan"><code>weathercan</code> package</a> and add it to <code>naturecounts</code> data for analysis.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>We’ll load the packages and filter the included data to only observations of black-capped chickadees since 2000. We’ll also convert the <code>ObservationCount</code>s to numeric for plotting later on.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(naturecounts)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(weathercan)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">bcch &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(bcch, survey_year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ObservationCount =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(ObservationCount))</a></code></pre></div>
</div>
<div id="download-climate-data" class="section level2">
<h2 class="hasAnchor">
<a href="#download-climate-data" class="anchor"></a>Download climate data</h2>
<div id="find-climate-stations" class="section level3">
<h3 class="hasAnchor">
<a href="#find-climate-stations" class="anchor"></a>Find climate stations</h3>
<p>The first step is to find data that matches the locations of our observations. To do this we need to see which locations we have.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">locs &lt;-<span class="st"> </span>bcch <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(latitude, longitude, survey_year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(latitude, longitude) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">start_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(survey_year), <span class="dt">end_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(survey_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">locs</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt; # A tibble: 41 x 4</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt;    latitude longitude start_year end_year</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#&gt;  1     45.4     -76.3       2013     2013</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">#&gt;  2     45.5     -77.7       2011     2011</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">#&gt;  3     45.5     -77.5       2011     2012</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">#&gt;  4     45.6     -77.4       2001     2004</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">#&gt;  5     45.6     -77.1       2012     2012</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#&gt;  6     45.6     -77.1       2012     2014</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt;  7     45.6     -77.1       2011     2011</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt;  8     45.6     -77.1       2008     2008</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt;  9     45.6     -77.2       2010     2010</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt; 10     45.6     -77.4       2011     2011</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt; # … with 31 more rows</span></a></code></pre></div>
<p>There are quite a few different locations (41), meaning we may have to download weather data independently for different sites. It will depend on how close these locations are to the available weather stations.</p>
<p>We’ll use the <code><a href="https://www.rdocumentation.org/packages/weathercan/topics/stations_search">stations_search()</a></code> function from the <a href="http://ropensci.github.io/weathercan"><code>weathercan</code> package</a> to find the closest station for each location. We only care about <strong>daily</strong> climate data (as opposed to hourly or monthly data), so we’ll specify <code>interval = "day"</code>. We’ll also filter the results to return only stations that were active during the period wherein that location was surveyed.</p>
<p>If you’re familiar with the <code>purrr</code> package, this could also be done with the <code>pmap()</code> function. However, for simplicity we will use a <code>for</code> loop here to look at each pair of locs (latitude and longitude), find the closest station within the specified data range and save it to a data frame (<code>stns</code>).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">stns &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>()</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(locs)) {</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  s1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/weathercan/topics/stations_search">stations_search</a></span>(<span class="dt">coords =</span> locs[i, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"latitude"</span>, <span class="st">"longitude"</span>)], <span class="dt">interval =</span> <span class="st">"day"</span>, <span class="dt">dist =</span> <span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(start <span class="op">&lt;=</span><span class="st"> </span>locs<span class="op">$</span>start_year[i], end <span class="op">&gt;=</span><span class="st"> </span>locs<span class="op">$</span>end_year[i]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="st">    </span><span class="kw">select</span>(prov, station_name, station_id, <span class="dt">stn_lat =</span> lat, <span class="dt">stn_lon =</span> lon, start, end, distance) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">latitude =</span> locs<span class="op">$</span>latitude[i], <span class="dt">longitude =</span> locs<span class="op">$</span>longitude[i]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  stns &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(stns, s1)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">}</a></code></pre></div>
<p>Let’s have a look at what we’ve got.</p>
<div id="htmlwidget-8a37426e072966abc04c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8a37426e072966abc04c">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41"],["QC","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","QC","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON"],["LUSKVILLE","ALGONQUIN PARK EAST GATE","PEMBROKE CLIMATE","COMBERMERE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","CHARTERIS","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","CHALK RIVER AECL","CHALK RIVER AECL","CHALK RIVER AECL","CHALK RIVER AECL"],["5604","42967","49068","4252","49068","49068","49068","6900","49068","49068","49068","49068","49068","49068","49068","49068","5584","6900","6900","6900","49068","49068","49068","49068","6900","6900","49068","49068","6900","6900","6900","49068","49068","49068","6900","6900","6900","4243","4243","4243","4243"],[45.53,45.53,45.86,45.37,45.86,45.86,45.86,45.88,45.86,45.86,45.86,45.86,45.86,45.86,45.86,45.86,45.68,45.88,45.88,45.88,45.86,45.86,45.86,45.86,45.88,45.88,45.86,45.86,45.88,45.88,45.88,45.86,45.86,45.86,45.88,45.88,45.88,46.05,46.05,46.05,46.05],[-76.05,-78.27,-77.25,-77.62,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-76.43,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.37,-77.37,-77.37,-77.37],[1980,2004,2010,1956,2010,2010,2010,1993,2010,2010,2010,2010,2010,2010,2010,2010,1980,1993,1993,1993,2010,2010,2010,2010,1993,1993,2010,2010,1993,1993,1993,2010,2010,2010,1993,1993,1993,1960,1960,1960,1960],[2018,2018,2018,2009,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018,2018],[24.5977491610495,41.1826197050285,43.5828029035188,26.1855771105435,30.8918087341807,29.2468131984281,29.2291424595923,30.9150727039419,26.7471970758166,28.8061490757329,30.8967458156769,28.9701079211147,28.9215111019162,28.5438313841799,31.8853964364434,27.9683054215073,30.1615442537386,28.5908751829531,28.7077052061648,27.9410350698798,10.6805585855178,7.13114841075176,17.2075621292841,27.9706676588744,11.0028395420643,11.0022600001228,5.10824752341525,11.4428118152084,7.56214579973475,11.6635362010829,11.6638500489697,11.1066590839354,9.67147168342266,2.64817733527523,0.532966446694274,0.602986316456437,4.96220140821924,7.2096616713213,11.9312356534282,8.04110550619129,23.9722780540162],[45.438354,45.487305,45.511097,45.557571,45.600586,45.614037,45.617878,45.61908,45.61956,45.620159,45.626408,45.632854,45.633461,45.634361,45.66671,45.772522,45.790867,45.791409,45.791702,45.79464,45.809177,45.812191,45.812889,45.81522,45.815529,45.815537,45.818989,45.821163,45.821648,45.827316,45.82732,45.828514,45.830921,45.838654,45.884056,45.884274,45.886333,45.99577,46.050598,46.085766,46.167706],[-76.336388,-77.746513,-77.505333,-77.417389,-77.107544,-77.11647,-77.103424,-77.112358,-77.235771,-77.390266,-77.034775,-77.067413,-77.067146,-77.074837,-76.947128,-76.912582,-76.783707,-76.904511,-76.902756,-76.91172,-77.366669,-77.188789,-77.039017,-76.895714,-77.142509,-77.142509,-77.220322,-77.113586,-77.300064,-77.120125,-77.120117,-77.114304,-77.132652,-77.234856,-77.246338,-77.245216,-77.313278,-77.421082,-77.524162,-77.460342,-77.629822]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>prov<\/th>\n      <th>station_name<\/th>\n      <th>station_id<\/th>\n      <th>stn_lat<\/th>\n      <th>stn_lon<\/th>\n      <th>start<\/th>\n      <th>end<\/th>\n      <th>distance<\/th>\n      <th>latitude<\/th>\n      <th>longitude<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":50,"columnDefs":[{"className":"dt-right","targets":[4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>Luckily, many of these sites list the same station (Petawawa Hoffman, 6900), but some more than 40km away. Whether or not this is considered too far, depends on the analysis being conducted. For now we’ll accept it.</p>
<p><strong>Note:</strong> in this situation, all sites returned a climate station, but sometimes there are no stations close enough within the specified data range. These sites would not appear in this data.</p>
<p>Next we’ll download the data for these stations in our date range. But first, we’ll store the matched stations with their sites.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">locs &lt;-<span class="st"> </span><span class="kw">left_join</span>(locs, <span class="kw">select</span>(stns, station_id, latitude, longitude),</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                  <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"latitude"</span>, <span class="st">"longitude"</span>))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">locs</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; # A tibble: 41 x 5</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt;    latitude longitude start_year end_year station_id</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt;       &lt;dbl&gt;     &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt; &lt;fct&gt;     </span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt;  1     45.4     -76.3       2013     2013 5604      </span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt;  2     45.5     -77.7       2011     2011 42967     </span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt;  3     45.5     -77.5       2011     2012 49068     </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt;  4     45.6     -77.4       2001     2004 4252      </span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt;  5     45.6     -77.1       2012     2012 49068     </span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt;  6     45.6     -77.1       2012     2014 49068     </span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt;  7     45.6     -77.1       2011     2011 49068     </span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt;  8     45.6     -77.1       2008     2008 6900      </span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt;  9     45.6     -77.2       2010     2010 49068     </span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; 10     45.6     -77.4       2011     2011 49068     </span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; # … with 31 more rows</span></a></code></pre></div>
<p>Now we can create a list of stations, and start and end dates for the data we need.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">stns &lt;-<span class="st"> </span>locs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(station_id, start_year, end_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(station_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">min_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(start_year), <span class="dt">max_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(end_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="st">  </span><span class="co"># Add jan 01 to the years to get the date format that weathercan expects</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">min_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(min_year, <span class="st">"-01-01"</span>), </a>
<a class="sourceLine" id="cb5-7" data-line-number="7">         <span class="dt">max_year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(max_year, <span class="st">"-01-01"</span>))</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">stns</a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt; # A tibble: 7 x 3</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt;   station_id min_year   max_year  </span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt;   &lt;fct&gt;      &lt;chr&gt;      &lt;chr&gt;     </span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt; 1 4243       2012-01-01 2014-01-01</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; 2 4252       2001-01-01 2004-01-01</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt; 3 5584       2013-01-01 2013-01-01</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; 4 5604       2013-01-01 2013-01-01</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; 5 6900       2001-01-01 2017-01-01</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt; 6 42967      2011-01-01 2011-01-01</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#&gt; 7 49068      2010-01-01 2015-01-01</span></a></code></pre></div>
<p>So we know which stations and which years we need data for. Now to download the data! If all the data have approximately the same date range, we could download everything at once, simply by specifying the outer limits of the date range:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">climate &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/weathercan/topics/weather_dl">weather_dl</a></span>(<span class="dt">station_ids =</span> stns<span class="op">$</span>station_id,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                      <span class="dt">start =</span> <span class="st">"2001-01-01"</span>, <span class="dt">end =</span> <span class="st">"2017-01-01"</span>, </a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                      <span class="dt">interval =</span> <span class="st">"day"</span>)</a></code></pre></div>
<p>However, where the date ranges differ by a substantial amount, it might be a faster download to loop over the stations individually.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">climate &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(stns)) {</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  climate &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(climate, </a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                   <span class="kw"><a href="https://www.rdocumentation.org/packages/weathercan/topics/weather_dl">weather_dl</a></span>(<span class="dt">station_ids =</span> stns<span class="op">$</span>station_id[i],</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                              <span class="dt">start =</span> stns<span class="op">$</span>min_year[i],</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                              <span class="dt">end =</span> stns<span class="op">$</span>max_year[i],</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">                              <span class="dt">interval =</span> <span class="st">"day"</span>))</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; Some variables have non-numeric values (spd_max_gust), for stations: 42967</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt;   Replaced all non-numeric entries with NA. Use 'string_as = NULL' to keep as characters (see ?weather_dl).</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; Some variables have non-numeric values (spd_max_gust), for stations: 49068</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt;   Replaced all non-numeric entries with NA. Use 'string_as = NULL' to keep as characters (see ?weather_dl).</span></a></code></pre></div>
</div>
</div>
<div id="joining-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#joining-the-data" class="anchor"></a>Joining the data</h2>
<p>Now that we have the data, we can join it to our naturecounts data.</p>
<p>First we’ll create a dates column.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">bcch &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/format_dates.html">format_dates</a></span>(bcch)</a></code></pre></div>
<p>Now we’ll add the station ids.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">bcch &lt;-<span class="st"> </span><span class="kw">left_join</span>(bcch, <span class="kw">select</span>(locs, station_id, latitude, longitude),</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">                  <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"latitude"</span>, <span class="st">"longitude"</span>))</a></code></pre></div>
<p>Finally we’ll add the daily temperature data by date and by station id.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">bcch &lt;-<span class="st"> </span><span class="kw">left_join</span>(bcch, <span class="kw">select</span>(climate, station_id, date, mean_temp),</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">                  <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"station_id"</span>, <span class="st">"date"</span>))</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt; Warning: Column `station_id` joining factor and character vector, coercing</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; into character vector</span></a></code></pre></div>
<p>Let’s take a quick look at the data.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> bcch, <span class="kw">aes</span>(<span class="dt">x =</span> mean_temp, <span class="dt">y =</span> ObservationCount)) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>()</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt; Warning: Removed 13 rows containing missing values (geom_point).</span></a></code></pre></div>
<p><img src="climate-data_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Looks like the big flocks are only observed when temperatures are getting chilly. Interestingly, it also looks like those data are from Christmas bird counts. So perhaps it is that more birds are detected during a Christmas Bird count, which generally takes place during chillier weather.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(bcch, ObservationCount <span class="op">&gt;</span><span class="st"> </span><span class="dv">300</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw">pull</span>(Locality) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>()</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt; [1] "Christmas Bird Count, Pembroke"      </span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; [2] "PAFN: Christmas Bird Count, Pembroke"</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; [3] NA                                    </span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; [4] "PAFN: Killaloe Christmas Bird Count"</span></a></code></pre></div>
<p>If we look at the data excluding Christmas bird counts</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(bcch, <span class="op">!</span><span class="kw">str_detect</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/chartr">tolower</a></span>(Locality), <span class="st">"christmas"</span>)),</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">       <span class="kw">aes</span>(<span class="dt">x =</span> mean_temp, <span class="dt">y =</span> ObservationCount)) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>()</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; Warning: Removed 12 rows containing missing values (geom_point).</span></a></code></pre></div>
<p><img src="climate-data_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li><a href="#download-climate-data">Download climate data</a></li>
      <li><a href="#joining-the-data">Joining the data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Steffi LaZerte, Denis LePage.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
