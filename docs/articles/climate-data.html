<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adding Climate Data • naturecounts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Adding Climate Data">
<meta property="og:description" content="naturecounts">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">naturecounts</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BirdStudiesCanada/naturecounts" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="climate-data_files/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="climate-data_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="climate-data_files/datatables-binding-0.20/datatables.js"></script><link href="climate-data_files/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="climate-data_files/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="climate-data_files/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="climate-data_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="climate-data_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Adding Climate Data</h1>
            
            <h4 data-toc-skip class="date">2022-02-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/BirdStudiesCanada/naturecounts/blob/HEAD/vignettes/articles/climate-data.Rmd" class="external-link"><code>vignettes/articles/climate-data.Rmd</code></a></small>
      <div class="hidden name"><code>climate-data.Rmd</code></div>

    </div>

    
    
<p>Climate data can be important in analyses of population presence/absence as some species may be more or less active depending on rain, temperature, or wind. Climate may also affect the odds of detecting species that are present (e.g., in windy conditions it may be harder to detect small birds in trees or to hear their vocalizations).</p>
<p>In this tutorial we will download climate data from Environment and Climate Change Canada using the <a href="http://ropensci.github.io/weathercan" class="external-link"><code>weathercan</code> package</a> and add it to <code>naturecounts</code> data for analysis.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We’ll load the packages and filter the included data to only observations of black-capped chickadees since 2000. We’ll also convert the <code>ObservationCount</code>s to numeric for plotting later on.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BirdStudiesCanada/naturecounts" class="external-link">naturecounts</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/weathercan/" class="external-link">weathercan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>

<span class="va">bcch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bcch</span>, <span class="va">survey_year</span> <span class="op">&gt;</span> <span class="fl">2000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ObservationCount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ObservationCount</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="download-climate-data">Download climate data<a class="anchor" aria-label="anchor" href="#download-climate-data"></a>
</h2>
<div class="section level3">
<h3 id="find-climate-stations">Find climate stations<a class="anchor" aria-label="anchor" href="#find-climate-stations"></a>
</h3>
<p>The first step is to find data that matches the locations of our observations. To do this we need to see which locations we have.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">locs</span> <span class="op">&lt;-</span> <span class="va">bcch</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">latitude</span>, <span class="va">longitude</span>, <span class="va">survey_year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">latitude</span>, <span class="va">longitude</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>start_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">survey_year</span><span class="op">)</span>, end_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">survey_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'latitude'. You can override using the</span>
<span class="co">#&gt; `.groups` argument.</span>
<span class="va">locs</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 41 × 4</span></span>
<span class="co">#&gt;    latitude longitude start_year end_year</span>
<span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     45.4     -<span style="color: #BB0000;">76.3</span>       <span style="text-decoration: underline;">2</span>013     <span style="text-decoration: underline;">2</span>013</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     45.5     -<span style="color: #BB0000;">77.7</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     45.5     -<span style="color: #BB0000;">77.5</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>012</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     45.6     -<span style="color: #BB0000;">77.4</span>       <span style="text-decoration: underline;">2</span>001     <span style="text-decoration: underline;">2</span>004</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>012     <span style="text-decoration: underline;">2</span>012</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>012     <span style="text-decoration: underline;">2</span>014</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>008     <span style="text-decoration: underline;">2</span>008</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     45.6     -<span style="color: #BB0000;">77.2</span>       <span style="text-decoration: underline;">2</span>010     <span style="text-decoration: underline;">2</span>010</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     45.6     -<span style="color: #BB0000;">77.4</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 31 more rows</span></span></code></pre></div>
<p>There are quite a few different locations (41), meaning we may have to download weather data independently for different sites. It will depend on how close these locations are to the available weather stations.</p>
<p>We’ll use the <code><a href="https://docs.ropensci.org/weathercan/reference/stations_search.html" class="external-link">stations_search()</a></code> function from the <a href="http://ropensci.github.io/weathercan" class="external-link"><code>weathercan</code> package</a> to find the closest station for each location. We only care about <strong>daily</strong> climate data (as opposed to hourly or monthly data), so we’ll specify <code>interval = "day"</code>. We’ll also filter the results to return only stations that were active during the period wherein that location was surveyed.</p>
<p>If you’re familiar with the <code>purrr</code> package, this could also be done with the <code><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">pmap()</a></code> function. However, for simplicity we will use a <code>for</code> loop here to look at each pair of locs (latitude and longitude), find the closest station within the specified data range and save it to a data frame (<code>stns</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">locs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/weathercan/reference/stations_search.html" class="external-link">stations_search</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="va">locs</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"latitude"</span>, <span class="st">"longitude"</span><span class="op">)</span><span class="op">]</span>, interval <span class="op">=</span> <span class="st">"day"</span>, dist <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">start</span> <span class="op">&lt;=</span> <span class="va">locs</span><span class="op">$</span><span class="va">start_year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">end</span> <span class="op">&gt;=</span> <span class="va">locs</span><span class="op">$</span><span class="va">end_year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">prov</span>, <span class="va">station_name</span>, <span class="va">station_id</span>, stn_lat <span class="op">=</span> <span class="va">lat</span>, stn_lon <span class="op">=</span> <span class="va">lon</span>, <span class="va">start</span>, <span class="va">end</span>, <span class="va">distance</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>latitude <span class="op">=</span> <span class="va">locs</span><span class="op">$</span><span class="va">latitude</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, longitude <span class="op">=</span> <span class="va">locs</span><span class="op">$</span><span class="va">longitude</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="va">stns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">stns</span>, <span class="va">s1</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Let’s have a look at what we’ve got.</p>
<div id="htmlwidget-0dd41ae8d0b2285f7c4e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0dd41ae8d0b2285f7c4e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41"],["QC","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","QC","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON","ON"],["LUSKVILLE","ALGONQUIN PARK EAST GATE","PEMBROKE CLIMATE","COMBERMERE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","CHARTERIS","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PEMBROKE CLIMATE","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","PETAWAWA HOFFMAN","CHALK RIVER AECL","CHALK RIVER AECL","CHALK RIVER AECL","CHALK RIVER AECL"],[5604,42967,49068,4252,49068,49068,49068,6900,49068,49068,49068,49068,49068,49068,49068,49068,5584,6900,6900,6900,49068,49068,49068,49068,6900,6900,49068,49068,6900,6900,6900,49068,49068,49068,6900,6900,6900,4243,4243,4243,4243],[45.53,45.53,45.86,45.37,45.86,45.86,45.86,45.88,45.86,45.86,45.86,45.86,45.86,45.86,45.86,45.86,45.68,45.88,45.88,45.88,45.86,45.86,45.86,45.86,45.88,45.88,45.86,45.86,45.88,45.88,45.88,45.86,45.86,45.86,45.88,45.88,45.88,46.05,46.05,46.05,46.05],[-76.05,-78.27,-77.25,-77.62,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-76.43,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.25,-77.37,-77.37,-77.37,-77.37],[1980,2004,2010,1956,2010,2010,2010,1993,2010,2010,2010,2010,2010,2010,2010,2010,1980,1993,1993,1993,2010,2010,2010,2010,1993,1993,2010,2010,1993,1993,1993,2010,2010,2010,1993,1993,1993,1960,1960,1960,1960],[2021,2021,2021,2009,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021,2021],[24.5977491610495,41.1826197050285,43.5828029035188,26.1855771105435,30.8918087341807,29.2468131984281,29.2291424595923,30.9150727039419,26.7471970758166,28.8061490757329,30.8967458156769,28.9701079211147,28.9215111019162,28.5438313841799,31.8853964364434,27.9683054215073,30.1615442537386,28.5908751829531,28.7077052061648,27.9410350698798,10.6805585855178,7.13114841075176,17.2075621292841,27.9706676588744,11.0028395420643,11.0022600001228,5.10824752341525,11.4428118152084,7.56214579973475,11.6635362010829,11.6638500489697,11.1066590839354,9.67147168342266,2.64817733527523,0.532966446694274,0.602986316456437,4.96220140821924,7.2096616713213,11.9312356534282,8.04110550619129,23.9722780540162],[45.438354,45.487305,45.511097,45.557571,45.600586,45.614037,45.617878,45.61908,45.61956,45.620159,45.626408,45.632854,45.633461,45.634361,45.66671,45.772522,45.790867,45.791409,45.791702,45.79464,45.809177,45.812191,45.812889,45.81522,45.815529,45.815537,45.818989,45.821163,45.821648,45.827316,45.82732,45.828514,45.830921,45.838654,45.884056,45.884274,45.886333,45.99577,46.050598,46.085766,46.167706],[-76.336388,-77.746513,-77.505333,-77.417389,-77.107544,-77.11647,-77.103424,-77.112358,-77.235771,-77.390266,-77.034775,-77.067413,-77.067146,-77.074837,-76.947128,-76.912582,-76.783707,-76.904511,-76.902756,-76.91172,-77.366669,-77.188789,-77.039017,-76.895714,-77.142509,-77.142509,-77.220322,-77.113586,-77.300064,-77.120125,-77.120117,-77.114304,-77.132652,-77.234856,-77.246338,-77.245216,-77.313278,-77.421082,-77.524162,-77.460342,-77.629822]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>prov<\/th>\n      <th>station_name<\/th>\n      <th>station_id<\/th>\n      <th>stn_lat<\/th>\n      <th>stn_lon<\/th>\n      <th>start<\/th>\n      <th>end<\/th>\n      <th>distance<\/th>\n      <th>latitude<\/th>\n      <th>longitude<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":50,"columnDefs":[{"className":"dt-right","targets":[3,4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>Luckily, many of these sites list the same station (Petawawa Hoffman, 6900), but some more than 40km away. Whether or not this is considered too far, depends on the analysis being conducted. For now we’ll accept it.</p>
<p><strong>Note:</strong> in this situation, all sites returned a climate station, but sometimes there are no stations close enough within the specified data range. These sites would not appear in this data.</p>
<p>Next we’ll download the data for these stations in our date range. But first, we’ll store the matched stations with their sites.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">locs</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stns</span>, <span class="va">station_id</span>, <span class="va">latitude</span>, <span class="va">longitude</span><span class="op">)</span>,
                  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"latitude"</span>, <span class="st">"longitude"</span><span class="op">)</span><span class="op">)</span>
<span class="va">locs</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 41 × 5</span></span>
<span class="co">#&gt;    latitude longitude start_year end_year station_id</span>
<span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     45.4     -<span style="color: #BB0000;">76.3</span>       <span style="text-decoration: underline;">2</span>013     <span style="text-decoration: underline;">2</span>013       <span style="text-decoration: underline;">5</span>604</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     45.5     -<span style="color: #BB0000;">77.7</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011      <span style="text-decoration: underline;">42</span>967</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     45.5     -<span style="color: #BB0000;">77.5</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>012      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     45.6     -<span style="color: #BB0000;">77.4</span>       <span style="text-decoration: underline;">2</span>001     <span style="text-decoration: underline;">2</span>004       <span style="text-decoration: underline;">4</span>252</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>012     <span style="text-decoration: underline;">2</span>012      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>012     <span style="text-decoration: underline;">2</span>014      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     45.6     -<span style="color: #BB0000;">77.1</span>       <span style="text-decoration: underline;">2</span>008     <span style="text-decoration: underline;">2</span>008       <span style="text-decoration: underline;">6</span>900</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     45.6     -<span style="color: #BB0000;">77.2</span>       <span style="text-decoration: underline;">2</span>010     <span style="text-decoration: underline;">2</span>010      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     45.6     -<span style="color: #BB0000;">77.4</span>       <span style="text-decoration: underline;">2</span>011     <span style="text-decoration: underline;">2</span>011      <span style="text-decoration: underline;">49</span>068</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 31 more rows</span></span></code></pre></div>
<p>Now we can create a list of stations, and start and end dates for the data we need.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stns</span> <span class="op">&lt;-</span> <span class="va">locs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">station_id</span>, <span class="va">start_year</span>, <span class="va">end_year</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">station_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>min_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">start_year</span><span class="op">)</span>, max_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">end_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="co"># Add jan 01 to the years to get the date format that weathercan expects</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>min_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">min_year</span>, <span class="st">"-01-01"</span><span class="op">)</span>, 
         max_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">max_year</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span>
<span class="va">stns</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 3</span></span>
<span class="co">#&gt;   station_id min_year   max_year  </span>
<span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       <span style="text-decoration: underline;">4</span>243 2012-01-01 2014-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       <span style="text-decoration: underline;">4</span>252 2001-01-01 2004-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       <span style="text-decoration: underline;">5</span>584 2013-01-01 2013-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       <span style="text-decoration: underline;">5</span>604 2013-01-01 2013-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       <span style="text-decoration: underline;">6</span>900 2001-01-01 2017-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span>      <span style="text-decoration: underline;">42</span>967 2011-01-01 2011-01-01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">7</span>      <span style="text-decoration: underline;">49</span>068 2010-01-01 2015-01-01</span></code></pre></div>
<p>So we know which stations and which years we need data for. Now to download the data! If all the data have approximately the same date range, we could download everything at once, simply by specifying the outer limits of the date range:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/weathercan/reference/weather_dl.html" class="external-link">weather_dl</a></span><span class="op">(</span>station_ids <span class="op">=</span> <span class="va">stns</span><span class="op">$</span><span class="va">station_id</span>,
                      start <span class="op">=</span> <span class="st">"2001-01-01"</span>, end <span class="op">=</span> <span class="st">"2017-01-01"</span>, 
                      interval <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></code></pre></div>
<p>However, where the date ranges differ by a substantial amount, it might be a faster download to loop over the stations individually.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">stns</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">climate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">climate</span>, 
                   <span class="fu"><a href="https://docs.ropensci.org/weathercan/reference/weather_dl.html" class="external-link">weather_dl</a></span><span class="op">(</span>station_ids <span class="op">=</span> <span class="va">stns</span><span class="op">$</span><span class="va">station_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                              start <span class="op">=</span> <span class="va">stns</span><span class="op">$</span><span class="va">min_year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                              end <span class="op">=</span> <span class="va">stns</span><span class="op">$</span><span class="va">max_year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                              interval <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Some variables have non-numeric values (spd_max_gust), for stations: 42967</span>
<span class="co">#&gt;   Replaced all non-numeric entries with NA. Use 'string_as = NULL' to keep as characters (see ?weather_dl).</span>
<span class="co">#&gt; Some variables have non-numeric values (spd_max_gust), for stations: 49068</span>
<span class="co">#&gt;   Replaced all non-numeric entries with NA. Use 'string_as = NULL' to keep as characters (see ?weather_dl).</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="joining-the-data">Joining the data<a class="anchor" aria-label="anchor" href="#joining-the-data"></a>
</h2>
<p>Now that we have the data, we can join it to our naturecounts data.</p>
<p>First we’ll create a dates column.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_dates.html">format_dates</a></span><span class="op">(</span><span class="va">bcch</span><span class="op">)</span></code></pre></div>
<p>Now we’ll add the station ids.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">bcch</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">locs</span>, <span class="va">station_id</span>, <span class="va">latitude</span>, <span class="va">longitude</span><span class="op">)</span>,
                  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"latitude"</span>, <span class="st">"longitude"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Finally we’ll add the daily temperature data by date and by station id.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">bcch</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">climate</span>, <span class="va">station_id</span>, <span class="va">date</span>, <span class="va">mean_temp</span><span class="op">)</span>,
                  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"station_id"</span>, <span class="st">"date"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s take a quick look at the data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bcch</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_temp</span>, y <span class="op">=</span> <span class="va">ObservationCount</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 13 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="climate-data_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Looks like the big flocks are only observed when temperatures are getting chilly. Interestingly, it also looks like those data are from Christmas bird counts. So perhaps it is that more birds are detected during a Christmas Bird count, which generally takes place during chillier weather.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bcch</span>, <span class="va">ObservationCount</span> <span class="op">&gt;</span> <span class="fl">300</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Locality</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "Christmas Bird Count, Pembroke"      </span>
<span class="co">#&gt; [2] "PAFN: Christmas Bird Count, Pembroke"</span>
<span class="co">#&gt; [3] NA                                    </span>
<span class="co">#&gt; [4] "PAFN: Killaloe Christmas Bird Count"</span></code></pre></div>
<p>If we look at the data excluding Christmas bird counts</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bcch</span>, <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">Locality</span><span class="op">)</span>, <span class="st">"christmas"</span><span class="op">)</span><span class="op">)</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_temp</span>, y <span class="op">=</span> <span class="va">ObservationCount</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 12 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="climate-data_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Steffi LaZerte, Denis LePage.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
